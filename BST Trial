# Libraries
library(ggplot2)
library(dplyr)
library(gam)
library(splines)
library(splines2)  
library(DAAG)
library(glmnet)
library(leaps)
#library(StepReg)
library(foreign)
library(Hmisc)
library(broom)
library(caret)
#library(vip)

# Set working directory and load data
getwd()
# if you are running this .R file in Rstudio
# install.packages("rstudioapi")
library(rstudioapi)
getActiveDocumentContext()$path
working_path <- dirname(getActiveDocumentContext()$path)
setwd(working_path)
getwd()

# Load data
data = read.csv("METABRIC_RNA_Mutation.csv", sep = ",", na.strings = c("", " "), header = TRUE)

newdata <- data[, c(2,20,29,32,33,34,36,37,39,43,52,152)]
newdata <- na.omit(newdata)
head(newdata)

tumor_size <- newdata$tumor_size
lymph_nodes_pos <- newdata$lymph_nodes_examined_positive
names(newdata)
summary(newdata)
summary(tumor_size)
par(mfrow=c(1,2))
hist(tumor_size)
hist(log(tumor_size))

hist(lymph_nodes_pos)

############Clementine's code#############

newdata$tumor_size_log <- log(newdata$tumor_size)

# scatter plots
plot(newdata$brca1, newdata$tumor_size_log, ylab = "log of tumor size",  xlab = "brca1 expression (z-score)")

# first model
lm1 = lm(tumor_size_log ~ brca1, data = newdata)
summary(lm1)
confint(lm1)
# correlation
cor.test(newdata$brca1, newdata$tumor_size_log)

lm1 = lm(tumor_size_log ~ brca1, data = newdata)

plot(lm1)

res<-residuals(lm1)
fit<-fitted.values(lm1)
mystd <- res/(sqrt(sum(res^2)/(length(res)-1-4))) # standardized 
stdres<-rstandard(lm1) # internally stud
stures<-rstudent(lm1) # externally stud
hat<-hatvalues(lm1)
cooksd<-cooks.distance(lm1)

# Assessing normality of the residuals
hist(stures,probability = TRUE)
curve(dnorm,from=-4,to=4,add=TRUE)
qqnorm(stures)
abline(0,1)
shapiro.test(stures)

hist(stdres,probability = TRUE)
curve(dnorm,from=-4,to=4,add=TRUE)
qqnorm(stdres)
abline(0,1)

# Examining observations with large internally/externally studentized residuals
d2<-newdata[,c("brca1","tumor_size_log")]
summary(d2[,-1])
d3<-cbind(d2,stdres,stures)
d3[abs(stdres)>2,]
d3[abs(stures)>2,]
d3[abs(stdres)>3,]
d3[abs(stures)>3,]

summary(hat)
mean(hat)
(thresh<-length(coef(lm1))/length(hat)) #(p+1)/n

# Creating a histogram & boxplot of the hat values
hist(hat)
boxplot(hat)
d2[hat>2*thresh,]
d2[hat>4*thresh,]

# See chart created in 2D for assessment of Cook's distances
summary(cooksd)

# Creating a histogram & boxplot of the Cook's distances
hist(cooksd)
boxplot(cooksd)
n<-length(cooksd)
d3<-cbind(d2,stures,hat,cooksd)
d3[cooksd>4/n,]
d3[cooksd>12/n,]

# Compare the model run on all observations to the model with outliers omitted
summary(lm(tumor_size_log ~ brca1, data = newdata))
hat_thresh<-length(coef(lm1))/length(hat)
newdata_no_outliers<-subset(newdata,abs(stures)<=3 & hat<=4*hat_thresh & cooksd<=12/n)
nrow(newdata)-nrow(newdata_no_outliers)
summary(lm(tumor_size_log ~ brca1, data = newdata,dat=newdata_no_outliers))

##***************##
####Statistical Model####
##***************##

newdata <- newdata[order(newdata$brca1),]

#linear model
model_linear <- lm(tumor_size_log ~ brca1, data=newdata)
summary(model_linear)
aic_linear <- extractAIC(model_linear)[2]  # Extract AIC value from the model
adj_r2_linear <- summary(model_linear)$adj.r.squared

#quadratic model
model_quad <- lm(tumor_size_log ~ brca1 + I(brca1^2), data=newdata)
summary(model_quad)
aic_quad <- extractAIC(model_quad)[2]  # Extract AIC value from the model
adj_r2_quad <- summary(model_quad)$adj.r.squared

#spline
model_spline=lm(tumor_size_log~bSpline(brca1,df=4),data=newdata)
summary(model_spline)
extractAIC(model_spline)
aic_spline <- extractAIC(model_spline)[2]  # Extract AIC value from the model
adj_r2_spline <- summary(model_spline)$adj.r.squared

#gam
newdata$brca1 <- scale(newdata$brca1)
model_gam <- gam(tumor_size_log~s(brca1,4),data=newdata)
summary(model_gam)
coef(model_gam)
aic_gam <- extractAIC(model_gam)[2]  # Extract AIC value from the model
adj_r2_gam <- NA

plot(tumor_size_log ~ brca1, data=newdata)
plot(tumor_size_log ~ brca1, data=newdata, col=rgb(0, 0, 0, 0.3), pch=16)
lines(newdata$brca1,fitted(model_linear), col="red")
lines(newdata$brca1,fitted(model_quad), col="blue")
lines(newdata$brca1,fitted(model_spline), col="green")
lines(newdata$brca1,fitted(model_gam), col="orange")
legend(x="topleft",legend=c("Linear","Quadratic","Spline", "GAM"),fill=c("red","blue","green","orange"))

# Create a matrix to store the results
result_matrix <- matrix(c(
  aic_linear, adj_r2_linear,
  aic_quad, adj_r2_quad,
  aic_spline, adj_r2_spline,
  aic_gam, adj_r2_gam
), ncol = 2, byrow = TRUE)

# Add row and column names for clarity
rownames(result_matrix) <- c("Linear Model", "Quadratic Model", "Spline Model", "GAM Model")
colnames(result_matrix) <- c("AIC", "Adjusted RÂ²")

# Convert matrix to data frame for better readability
result_df <- as.data.frame(result_matrix)

# Print the result matrix
print(result_df)
